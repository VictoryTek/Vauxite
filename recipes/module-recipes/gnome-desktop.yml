---
# yaml-language-server: $schema=https://schema.blue-build.org/module-v1.json
modules:
  - type: dnf
    #source: ghcr.io/blue-build/modules/dnf:dnf-module
    repos:
      cleanup: false # clean up added repos after module is done

    # Group installs
    group-install:
      with-optional: true
      packages:    
        - gnome-desktop

    remove:
      packages:  
        - waydroid

    install:
      packages:
        # Additional GNOME packages not always included in the base group
        - gnome-extensions-app    # Extension manager
        - gnome-shell-extensions  # Extra shell extensions

          # Additional GNOME applications that may not be in the default group
        - gnome-text-editor      # New GNOME text editor
  
        # Media support
        - gstreamer1-plugins-good
        - gstreamer1-plugins-bad-free
        - gstreamer1-plugins-ugly-free



    # Set GNOME as the default desktop
    postprocess:
      - |
        #!/bin/bash
        echo "Ensuring GNOME Desktop environment is fully installed..."
        dnf -y group install "GNOME Desktop" --with-optional
        
        echo "Enabling GDM service..."
        systemctl enable gdm.service
        
        # Set GNOME as the default session
        echo "Configuring default GNOME session settings..."
        mkdir -p /etc/skel/.config
        echo "[User]" > /etc/skel/.config/gnome-initial-setup-done
        echo "SystemAccount=false" >> /etc/skel/.config/gnome-initial-setup-done
        
        # Configure default desktop session for GDM
        if [ -f /var/lib/AccountsService/users/gdm ]; then
          sed -i 's/^Session=.*/Session=gnome/' /var/lib/AccountsService/users/gdm
        else
          mkdir -p /var/lib/AccountsService/users/
          echo "[User]" > /var/lib/AccountsService/users/gdm
          echo "Session=gnome" >> /var/lib/AccountsService/users/gdm
        fi
        
        # Enable GDM startup theme for a more polished boot experience
        if [ -f /usr/share/gdm/greeter-settings.ini ]; then
          if ! grep -q "Theme=true" /usr/share/gdm/greeter-settings.ini; then
            echo "Configuring GDM greeter settings..."
            echo "[org.gnome.login-screen]" >> /usr/share/gdm/greeter-settings.ini
            echo "logo='/usr/share/pixmaps/fedora-logo.png'" >> /usr/share/gdm/greeter-settings.ini
            echo "Theme=true" >> /usr/share/gdm/greeter-settings.ini
          fi
        fi
        
        echo "GNOME desktop environment setup complete."
